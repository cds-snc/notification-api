name: Build and deploy to master
on:
  push:
    branches:    
      - master
jobs:
  build:
    name: build and deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: AWS Decrypt
        uses: docker://gcr.io/cdssnc/aws:latest
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        with:
          entrypoint: sh
          args: -l -c "aws kms decrypt --ciphertext-blob fileb://.env.enc.aws --output text --query Plaintext --region us-east-1 | base64 --decode > .env"
      - name: AWS Docker
        uses: docker://gcr.io/cdssnc/aws:latest
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        with:
          entrypoint: sh
          args: -l -c "eval $(aws ecr get-login --no-include-email --region us-east-1 | sed 's|https://||')"
      - name: EKS
        uses: docker://gcr.io/cdssnc/aws:latest
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        with:
          args: eks --region us-east-1 update-kubeconfig --name notification-alpha-canada-ca
      - name: Build
        uses: docker://docker:stable
        with:
          entrypoint: sh
          args: -c "docker build -t ${{ secrets.AWS_REGISTRY }}/notification-canada-ca/api:${{ github.sha }} -t ${{ secrets.AWS_REGISTRY }}/notification-canada-ca/api:latest -f ci/Dockerfile ."
      - name: Push short
        uses: docker://docker:stable
        with:
          entrypoint: sh
          args: -c "docker push ${{ secrets.AWS_REGISTRY }}/notification-canada-ca/api:${{ github.sha }}"
      - name: Push latest
        uses: docker://docker:stable
        with:
          entrypoint: sh
          args: -c "docker push ${{ secrets.AWS_REGISTRY }}/notification-canada-ca/api:latest"
      - name: Apply API
        uses: docker://gcr.io/cdssnc/aws-kubectl:latest
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        with:
          args: set image deployment.apps/api api=${{ secrets.AWS_REGISTRY }}/notification-canada-ca/api:${{ github.sha }} -n=notification-canada-ca --kubeconfig=/github/home/.kube/config
      - name: Apply celery
        uses: docker://gcr.io/cdssnc/aws-kubectl:latest
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        with:
          args: set image deployment.apps/celery celery=${{ secrets.AWS_REGISTRY }}/notification-canada-ca/api:${{ github.sha }} -n=notification-canada-ca --kubeconfig=/github/home/.kube/config
      - name: Apply celery beat
        uses: docker://gcr.io/cdssnc/aws-kubectl:latest
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        with:
          args: set image deployment.apps/celery-beat celery-beat=${{ secrets.AWS_REGISTRY }}/notification-canada-ca/api:${{ github.sha }} -n=notification-canada-ca --kubeconfig=/github/home/.kube/config


