name: Build and Push dev Branch images to Dev, Staging and Prod ECRs

on:
  workflow_dispatch:
  push:
    branches:
      - dev

env:
  AWS_DEFAULT_REGION: ca-central-1

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: ["lambda", "k8s"]

    steps:
      - name: Checkout dev branch
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          ref: dev

      - name: Set image parameters
        id: img
        run: |
          if [ "${{ matrix.target }}" = "lambda" ]; then
            echo "image=api-lambda" >> "$GITHUB_OUTPUT"
            echo "dockerfile=ci/Dockerfile.lambda" >> "$GITHUB_OUTPUT"
          else
            echo "image=api" >> "$GITHUB_OUTPUT"
            echo "dockerfile=ci/Dockerfile" >> "$GITHUB_OUTPUT"
          fi

      - name: Build image
        run: |
          docker build \
            --build-arg GIT_SHA=${GITHUB_SHA::7} \
            -t ${{ steps.img.outputs.image }}:${GITHUB_SHA::7} \
            -t ${{ steps.img.outputs.image }}:latest \
            -f ${{ steps.img.outputs.dockerfile }} \
            .

      - name: Push image to all ECRs
        uses: ./.github/workflows/reusable_push_ecr.yml
        with:
          image-name: ${{ steps.img.outputs.image }}
          image-tag-sha: ${GITHUB_SHA::7}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
          branch-name: ${{ github.ref_name }}

      - name: Trigger manifests workflow for dev images
        if: ${{ success() && matrix.target == 'k8s' }}
        run: |
          curl -L \
          -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.MANIFESTS_WORKFLOW_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/cds-snc/notification-manifest/dispatches \
            -d '{"event_type":"deploy-dev-branch-images"}'
