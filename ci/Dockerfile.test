# Python 3.8 is supported until 14 October 2024.
# Alpine Linux 3.15 is supported until 1 November 2023.
FROM python:3.8-alpine3.15

ENV PYTHONDONTWRITEBYTECODE 1

WORKDIR /app
COPY requirements.txt requirements_for_test.txt /app/

RUN apk add --no-cache bash build-base postgresql-dev make libffi-dev libmagic libcurl python3-dev openssl-dev curl-dev git \
  && apk add --no-cache --virtual .build-deps musl-dev rust cargo \
  && set -ex \
  && python -m pip install --upgrade pip==22.0.4 \
  && python -m pip install wheel \
  # This installs both requirements files.
  && pip install --no-cache-dir -r requirements_for_test.txt \
  # Remove build dependencies.
  && rm requirements.txt requirements_for_test.txt \
  && apk del .build-deps

COPY . /app
CMD ["sh", "-c", "make test"]
